name: Ø¨Ù†Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙˆØ§ØªÙŠØ± - APK (Ø¨Ø¯ÙˆÙ† ØªÙˆÙ‚ÙŠØ¹)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
      architecture:
        description: 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬'
        required: true
        default: 'arm64'
        type: choice
        options:
          - arm64
          - armeabi
          - both

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
      uses: actions/checkout@v4
      
    - name: Ø¥Ø¹Ø¯Ø§Ø¯ Java (JDK 17)
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Ø¥Ø¹Ø¯Ø§Ø¯ Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        
    - name: Ø¥Ø¹Ø¯Ø§Ø¯ Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        build-tools: 33.0.2
        target: 'default'
        
    - name: ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ
      run: |
        echo "y" | sdkmanager --licenses
        echo "y" | sdkmanager --licenses all
        
    - name: ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
      run: flutter pub get
      
    - name: ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚
      run: flutter clean
      
    - name: ÙØ­Øµ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
      run: flutter doctor -v
      
    - name: Ø¨Ù†Ø§Ø¡ APK
      run: |
        echo "Ø¨Ø¯Ø£ Ø¨Ù†Ø§Ø¡ APK - Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡: ${{ github.event.inputs.build_type }}"
        echo "Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬: ${{ github.event.inputs.architecture }}"
        
        case "${{ github.event.inputs.architecture }}" in
          "arm64")
            flutter build apk --target-platform android-arm64 --${{ github.event.inputs.build_type }}
            ;;
          "armeabi")
            flutter build apk --target-platform android-arm --${{ github.event.inputs.build_type }}
            ;;
          "both")
            flutter build apk --target-platform android-arm64,android-arm --${{ github.event.inputs.build_type }}
            ;;
        esac
        
    - name: Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†Ø§Ø¡
      run: |
        echo "# ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙˆØ§ØªÙŠØ±" > build-report.md
        echo "" >> build-report.md
        echo "**ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ù†Ø§Ø¡:** $(date)" >> build-report.md
        echo "**Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡:** ${{ github.event.inputs.build_type }}" >> build-report.md
        echo "**Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬:** ${{ github.event.inputs.architecture }}" >> build-report.md
        echo "**ÙØ±Ø¹ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:** ${{ github.ref_name }}" >> build-report.md
        echo "**Ø±Ù‚Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ«:** ${{ github.run_number }}" >> build-report.md
        echo "" >> build-report.md
        echo "## ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù„Ù" >> build-report.md
        ls -la build/app/outputs/flutter-apk/ >> build-report.md
        echo "" >> build-report.md
        echo "## Ø­Ø¬Ù… Ø§Ù„Ù…Ù„ÙØ§Øª" >> build-report.md
        du -h build/app/outputs/flutter-apk/ >> build-report.md
        
    - name: Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
      uses: actions/upload-artifact@v4
      with:
        name: build-report
        path: build-report.md
        retention-days: 90
        
    - name: Ø±ÙØ¹ APK Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
      uses: actions/upload-artifact@v4
      with:
        name: invoice-pro-${{ github.event.inputs.build_type }}-${{ github.event.inputs.architecture }}
        path: build/app/outputs/flutter-apk/app-${{ github.event.inputs.build_type }}.apk
        retention-days: 90
        
    - name: Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.event.inputs.build_type }}
        path: |
          build/logs/
          build/reports/
        retention-days: 30
        
    - name: Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
      if: success()
      run: |
        echo "ğŸ‰ ØªÙ… Ø¨Ù†Ø§Ø¡ APK Ø¨Ù†Ø¬Ø§Ø­!"
        echo "Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡: ${{ github.event.inputs.build_type }}"
        echo "Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬: ${{ github.event.inputs.architecture }}"
        echo ""
        echo "ğŸ“± ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ APK Ù…Ù† ØªØ¨ÙˆÙŠØ¨ 'Artifacts' ÙÙŠ Ø£Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©"
        echo "â° Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…ØªØ§Ø­ Ù„Ù…Ø¯Ø© 90 ÙŠÙˆÙ…Ø§Ù‹"
        
    - name: Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
      if: failure()
      run: |
        echo "âŒ ÙØ´Ù„ ÙÙŠ Ø¨Ù†Ø§Ø¡ APK"
        echo ""
        echo "ğŸ”§ Ù†ØµØ§Ø¦Ø­ Ù„Ø­Ù„ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„:"
        echo "1. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© pubspec.yaml"
        echo "2. ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯"
        echo "3. Ø´ØºÙ„ workflow Ø§Ù„ØªØ´Ø®ÙŠØµ Ø£ÙˆÙ„Ø§Ù‹"
        echo ""
        echo "ğŸ“‹ Ø±Ø§Ø¬Ø¹ Ù…Ù„Ù build/logs/ Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„"